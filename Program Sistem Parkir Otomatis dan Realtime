#include <iostream>
#include <string>
#include <ctime>  
#include <cstdlib>  

using namespace std;


const int MAKS = 2; 
string dataPlat[MAKS];  
string KodeUnik[MAKS];        
int dataJenis[MAKS];            
time_t dataJamMasuk[MAKS];      
int jumlahKendaraan = 0;        

void tampilkanMenu();
void prosesMasuk();             
void prosesKeluar();            
int hitungBiaya(int jenis, int durasi); 

int main() {

    srand(time(0));
    char pilihan;
    
    do {
        tampilkanMenu();
        cin >> pilihan;
        cin.ignore(); 
        
        switch(pilihan) {
            case '1':
                prosesMasuk();
                break;
            case '2':
                prosesKeluar();
                break;
            case '0':
                cout << "Program Selesai. Terima Kasih!\n";
                break;
            default:
                cout << "Tidak valid, silakan coba lagi.\n";
        }
        
        cout << "\n Klik Enter untuk lanjut...";
        cin.get();
        cin.clear(); 
        
    } while (pilihan != '0');
    return 0;
}

void tampilkanMenu() {
    cout << "\n------------||------------\n";
    cout << "  | SISTEM PARKIR (OTOMATIS) |  \n";
    cout << "------------||------------\n";
    cout << ">>> Slot Parkir Tersedia: " << jumlahKendaraan << " / " << MAKS << " <<<";
    cout << "\n-------------------------------------\n";
    cout << "[1] Kendaraan Masuk\n";
    cout << "[2] Kendaraan Keluar\n";
    cout << "[0] Keluar Program\n";
    cout << "-------------------------------------\n";
    cout << "Pilih Kategori Menu [1/2/0]: ";
}

void prosesMasuk() {
    if (jumlahKendaraan >= MAKS) {
        cout << "\n[!] Maaf, Parkiran Sedang Penuh!\n";
        return;
    }
    
    cout << "\n ---||INPUT KENDARAAN MASUK||--- \n";
    
    cout << "Masukkan Nomor Plat Kendaraan : ";
    getline(cin, dataPlat[jumlahKendaraan]); 
    
    cout << "Kode Kendaraan ([1]Motor / [2]Mobil) : ";
    cin >> dataJenis[jumlahKendaraan];
    cin.ignore();
   
    string karakter = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
    string hasilkode = "PARK-";

    for(int k = 0; k < 5; k++){
        hasilkode += karakter[rand() % 36];
    }

    KodeUnik[jumlahKendaraan] = hasilkode;

    dataJamMasuk[jumlahKendaraan] = time(0);\

    cout << "\n---------------------------------\n";
    cout << ">>> Waktu Masuk Kendaraan : " << ctime(&dataJamMasuk[jumlahKendaraan]);
    cout << ">>> Kode Unik Parkir Kendaraan : " << KodeUnik[jumlahKendaraan] << endl;
    cout << ">>> Data Parkir Kendaraan Disimpan di Line ke-" << jumlahKendaraan << endl;
    
    jumlahKendaraan++;
}

void prosesKeluar() {
    if (jumlahKendaraan == 0) {
        cout << "\n[!] Belum ada kendaraan Terparkir!.\n";
        return;
    }

    string cariPlat, inputKode;
    cout << "\n ---||INPUT KENDARAAN KELUAR||--- \n";
    cout << "Masukkan Nomor Plat Kendaraaan : ";
    getline(cin, cariPlat);

    cout << "Masukkan Kode Unik Tiket     : ";
    getline(cin, inputKode);
    
    bool platDitemukan = false;
    
    for(int i = 0; i < jumlahKendaraan; i++) {
        if(dataPlat[i] == cariPlat) {
            platDitemukan = true;
            
            if (KodeUnik[i] == inputKode) {
                cout << "\nVerifikasi Kode Berhasil!\n";

                time_t waktuKeluar = time(0);
                double selisihDetik = difftime(waktuKeluar, dataJamMasuk[i]);
                long durasiJam = selisihDetik / 3600;
                long sisaDetik = (long)selisihDetik % 3600;
      
                if (sisaDetik > 0) durasiJam++;
                if (durasiJam < 1) durasiJam = 1;
       
                int totalBayar = hitungBiaya(dataJenis[i], durasiJam);   

                cout << "\n------------||------------\n";
                cout << "       STRUK PARKIR       \n";
                cout << "------------||------------\n";
                cout << "Plat Nomor     : " << dataPlat[i] << endl;
                cout << "Tipe           : " << (dataJenis[i] == 1 ? "Motor" : "Mobil") << endl;
                cout << "Kode Unik      : " << KodeUnik[i] << endl;
                cout << "Total Biaya    : Rp " << totalBayar << endl;
                cout << "--------------------------\n";
                
                for (int j = i; j < jumlahKendaraan - 1; j++) {
                    dataPlat[j] = dataPlat[j+1];
                    dataJenis[j] = dataJenis[j+1];
                    dataJamMasuk[j] = dataJamMasuk[j+1];
                    KodeUnik[j] = KodeUnik[j+1];
                }
                jumlahKendaraan--; 
                cout << "[Info] Kendaraan Sudah Keluar.\n";
                
            } else {
                cout << "\n[WARNING] Kode Tidak Cocok!\n";
                cout << "Kendaraan tidak dapat dikeluarkan. Harap periksa tiket surat-surat anda!\n";
            }
            break; 
        }
    }

    if(!platDitemukan) {
        cout << "\n[!] Data Plat Nomor tidak sesuai! Ulangi\n";
    }
}

int hitungBiaya(int jenis, int durasi) {
    int tarifPerJam = 0;
    
    if (jenis == 1) {
        tarifPerJam = 2000;
    } else if (jenis == 2) {
        tarifPerJam = 5000;
    }
    
    return tarifPerJam * durasi;
}
